#!/usr/bin/env node
/**
 * Uiua Documentation Scraper
 * 
 * Fetches primitive documentation from the Uiua GitHub repository
 * and generates a JSON file for use in hover docs.
 * 
 * Usage: node scripts/scrape-uiua-docs.cjs
 * 
 * Run this periodically to update the docs if upstream changes.
 */

const https = require('https');
const fs = require('fs');
const path = require('path');

const PRIMITIVES_URL = 'https://raw.githubusercontent.com/uiua-lang/uiua/main/site/primitives.json';

// Output path
const JS_OUTPUT_FILE = path.join(__dirname, '..', 'src', 'uiua-docs.js');

/**
 * Fetch a URL and return the content
 */
function fetchUrl(url) {
    return new Promise((resolve, reject) => {
        https.get(url, (res) => {
            if (res.statusCode === 301 || res.statusCode === 302) {
                fetchUrl(res.headers.location).then(resolve).catch(reject);
                return;
            }
            
            if (res.statusCode !== 200) {
                reject(new Error(`HTTP ${res.statusCode} for ${url}`));
                return;
            }
            
            // Set encoding to UTF-8 to properly handle multi-byte characters
            res.setEncoding('utf8');
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => resolve(data));
            res.on('error', reject);
        }).on('error', reject);
    });
}

/**
 * Map Uiua class names to simpler type names
 */
function classToType(className) {
    const typeMap = {
        'MonadicPervasive': 'monadic function',
        'DyadicPervasive': 'dyadic function',
        'MonadicArray': 'monadic function',
        'DyadicArray': 'dyadic function',
        'MappingModifier': 'modifier',
        'IteratingModifier': 'modifier',
        'InversionModifier': 'modifier',
        'OtherModifier': 'modifier',
        'Arguments': 'stack',
        'Constant': 'constant',
        'Misc': 'misc',
        'Debug': 'debug',
        'Encoding': 'encoding',
        'Algorithm': 'algorithm',
        'Map': 'map',
        'Thread': 'thread',
        'Time': 'time',
        'RNG': 'random',
        'Environment': 'environment',
        'Comptime': 'compile-time',
        // System functions
        'Media': 'system',
        'Env': 'system',
        'StdIO': 'system',
        'Stream': 'system',
        'Filesystem': 'system',
        'Command': 'system',
        'Tcp': 'system',
        'Udp': 'system',
        'Ffi': 'system',
    };
    return typeMap[className] || className.toLowerCase();
}

/**
 * Generate documentation URL for a primitive
 */
function getDocUrl(name) {
    // Convert name to URL-friendly format
    const urlName = name.replace(/ /g, '-').toLowerCase();
    return `https://www.uiua.org/docs/${urlName}`;
}

/**
 * Generate the JavaScript module
 */
function generateJsModule(data) {
    const jsContent = `/**
 * Uiua Primitive Documentation
 * 
 * Auto-generated by scripts/scrape-uiua-docs.cjs
 * Source: ${PRIMITIVES_URL}
 * Generated: ${new Date().toISOString()}
 * 
 * Run \`node scripts/scrape-uiua-docs.cjs\` to update from upstream docs.
 * 
 * LICENSE ATTRIBUTION:
 * The documentation content in this file is derived from the Uiua project.
 * Copyright (c) 2023 Kai Schmidt
 * Repository: https://github.com/uiua-lang/uiua
 * License: MIT License
 * See THIRD_PARTY_LICENSES.md for full license text.
 */

export const uiuaDocsMeta = {
    "language": "Uiua",
    "source": "${PRIMITIVES_URL}",
    "scrapedAt": "${new Date().toISOString()}",
    "version": "1.0.0"
};

export const uiuaGlyphDocs = ${JSON.stringify(data.primitives, null, 4)};

/**
 * Get hover content for a Uiua glyph
 * @param {string} glyph - The glyph to look up
 * @returns {object|null} - The documentation object or null if not found
 */
export function getUiuaHoverContent(glyph) {
    return uiuaGlyphDocs[glyph] || null;
}
`;
    return jsContent;
}

/**
 * Main scraping function
 */
async function scrapeUiuaDocs() {
    console.log('Uiua Documentation Scraper');
    console.log('==========================\n');
    
    console.log(`Fetching ${PRIMITIVES_URL}...`);
    const rawJson = await fetchUrl(PRIMITIVES_URL);
    const primitives = JSON.parse(rawJson);
    
    console.log(`Found ${Object.keys(primitives).length} primitives\n`);
    
    // Process primitives - only include those with glyphs (not system functions)
    const docs = {};
    const stats = {
        'monadic function': 0,
        'dyadic function': 0,
        'modifier': 0,
        'stack': 0,
        'constant': 0,
        'other': 0,
    };
    
    for (const [name, info] of Object.entries(primitives)) {
        // Skip system functions (those starting with &) and deprecated ones
        if (name.startsWith('&')) continue;
        if (info.deprecated) continue;
        
        // Only include primitives with glyphs
        const glyph = info.glyph || info.ascii;
        if (!glyph) continue;
        
        const type = classToType(info.class);
        
        // Build signature info
        let signature = '';
        if (info.args !== undefined && info.outputs !== undefined) {
            signature = `${info.args} â†’ ${info.outputs}`;
        }
        if (info.modifier_args) {
            signature = signature ? `|${info.modifier_args}| ${signature}` : `|${info.modifier_args}|`;
        }
        
        docs[glyph] = {
            glyph: glyph,
            type: type,
            name: name,
            description: info.description,
            signature: signature,
            docUrl: getDocUrl(name),
        };
        
        // Track stats
        if (stats[type] !== undefined) {
            stats[type]++;
        } else {
            stats['other']++;
        }
    }
    
    // Build output structure
    const output = {
        meta: {
            language: 'Uiua',
            source: PRIMITIVES_URL,
            scrapedAt: new Date().toISOString(),
            count: Object.keys(docs).length,
        },
        primitives: docs,
    };
    
    // Write JavaScript module
    const jsContent = generateJsModule(output);
    fs.writeFileSync(JS_OUTPUT_FILE, jsContent);
    console.log(`Wrote ${Object.keys(docs).length} primitives to ${JS_OUTPUT_FILE}`);
    
    // Print summary
    console.log('\nSummary:');
    for (const [type, count] of Object.entries(stats)) {
        if (count > 0) {
            console.log(`  ${type}: ${count}`);
        }
    }
}

// Run the scraper
scrapeUiuaDocs().catch(err => {
    console.error('Error:', err.message);
    process.exit(1);
});
